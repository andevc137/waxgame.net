<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Wax Game</title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://momentjs.com/downloads/moment.js"></script>
        <script src="bundle.js"></script>
    </head>
    <body>
        <h4>Hello <span id="waxid"></span>!</h4>
        <button id="login" onclick="login()">WAX Login</button>
        <button id="mine" onclick="mine()">AW mine</button>
        <button id="claim" onclick="claim()" disabled>AW claim</button>
        <p>Delay <span id="delay"></span> s !</p>
        <p>Next claim in <span id="next-claim">NaN</span>s.</p>
        <p id="result"></p>
    </body>
    <script>
        let waxid;
        let nonce;
        let delay;

        async function login() {
            try {
                const userAccount = await wax.login();
                document.getElementById("waxid").innerText = userAccount;
                waxid = userAccount;
                document.getElementById("login").disabled = true
            } catch (e) {
                document.getElementById("waxid").innerText = e.message;
            }
        }

        async function getLastTx() {
            return axios.get('/api/get_lastmine/' + waxid).then(res => {
                return res.data.rows[0].last_mine_tx
            })
        }

        async function prepareData() {
            const data = await Promise.all([
                axios.get(`/api/get_table_rows/${waxid}/miners`),
                axios.get(`/api/get_table_rows/${waxid}/bags`)
            ])

            if (data[0].data.rows.length * data[1].data.rows.length === 0)
                throw -1

            const bags = data[1].data.rows[0].items
            const miners = data[0].data.rows[0]

            const procs = [
                axios.get(`/api/atomicassets/${miners.current_land}`)
            ]

            for(const itemid of bags) {
                procs.push(axios.get(`/api/atomicassets/${itemid}`))
            }

            const itemsData = await Promise.all(procs)

            const landMulti = itemsData[0].data.data.data.delay / 10
            const landDifficulty = itemsData[0].data.data.data.difficulty

            itemsData.shift()
            const calc = itemsData.reduce((a, o) => {
                a.delay.push(o.data.data.data.delay)
                a.difficulty += o.data.data.data.difficulty

                return a
            }, {delay: [], difficulty: 0})

            calc.delay.sort((a,b) => Number(a) - Number(b))

            if (calc.delay.length >= 3) calc.delay.shift()
            const toolsDelay = calc.delay.reduce((a,b) => a + b, 0)

            return {
                ...miners,
                bags,
                delay: landMulti * toolsDelay,
                difficulty: landDifficulty * calc.difficulty
            }
        }

        async function makeTransaction(action, data, permission = "active") {
            if (! waxid) {
                document.querySelector('#result').innerText = '[Finished] - Error - Login first'
                return
            }
            document.querySelector('#result').innerText = ''

            // action = { account: "m.federation", name: "setbag"}

            wax.api.transact({
                actions: [{
                    ...action,
                    authorization: [{
                        actor: waxid,
                        permission: permission
                    }],
                    data: data
                }]
            }, {
                blocksBehind: 3,
                expireSeconds: 30
            })
            .then(r => {
                console.log(r)
                document.querySelector('#result').innerText = '[Finished] - Successful - Transaction id ' + r.transaction_id
            })
            .catch(e => {
                console.error(e)
                document.querySelector('#result').innerText = '[Finished] - Error - ' + e.message
            })
        }

        async function transact(actions) {
            if (! waxid) {
                document.querySelector('#result').innerText = '[Finished] - Error - Login first'
                return
            }

            document.querySelector('#result').innerText = ''

            actions = actions.map(r => {
                if (! r.hasOwnProperty('authorization')) {
                    r.authorization = [{
                        actor: waxid,
                        permission: 'active'
                    }]
                }

                return r
            })

            wax.api.transact({
                actions: actions
            }, {
                blocksBehind: 3,
                expireSeconds: 30
            })
            .then(r => {
                console.log(r)
                document.querySelector('#result').innerText = '[Finished] - Successful - Transaction id ' + r.transaction_id
            })
            .catch(e => {
                console.error(e)
                document.querySelector('#result').innerText = '[Finished] - Error - ' + e.message
            })
        }

        async function mine() {
            if (! waxid) {
                document.querySelector('#result').innerText = '[Finished] - Error - Login first'
                return
            }

            document.getElementById("mine").disabled = true
            document.getElementById("claim").disabled = true
            console.log('MINE')
            document.querySelector('#result').innerText = ''

            if (! nonce) {
                let maxTries = 10
                let tries = 0
                let minerInfo
                while(! minerInfo && ++tries < maxTries) {
                    try{
                        minerInfo = await prepareData()
                    }
                    catch (e) {
                        if (e === -1) {
                            document.querySelector('#result').innerText = '[Finished] - Error - Invalid Account'
                            document.getElementById("mine").disabled = false
                            document.getElementById("claim").disabled = false
                            return
                        }
                    }
                }

                delay = minerInfo.delay
                const remains = moment(minerInfo.last_mine + '.000Z').add(delay, 'seconds').diff(new Date(), 'seconds')
                console.log('remains', remains)
                document.querySelector('#delay').innerText = '' + delay

                if (remains > 0) {
                    document.querySelector('#result').innerText = '[Finished] - Error - Mine too soon'
                    document.getElementById("mine").disabled = false
                    document.getElementById("claim").disabled = false
                    document.getElementById("next-claim").innerText = '' + remains
                    return
                }

                nonce = GenerateNonce(waxid, waxid, minerInfo.difficulty, minerInfo.last_mine_tx).rand_str
            }

            console.log('nonce', nonce)
            document.getElementById("claim").disabled = false
        }

        function claim() {
            document.getElementById("claim").disabled = true

            wax.api.transact({
                actions: [{
                    account: "m.federation",
                    name: "mine",
                    authorization: [{
                        actor: waxid,
                        permission: "active"
                    }],
                    data: {
                        miner: waxid,
                        nonce: nonce
                    }
                }]
            }, {
                blocksBehind: 3,
                expireSeconds: 30
            })
            .then(r => {
                nonce = null
                console.log(r)
                document.querySelector('#result').innerText = '[Finished] - Successful - Transaction id ' + r.transaction_id
                document.getElementById("claim").disabled = true
                document.getElementById("mine").disabled = false
            })
            .catch(e => {
                console.error(e)
                document.querySelector('#result').innerText = '[Finished] - Error - ' + e.message
                document.getElementById("claim").disabled = false
            })
        }
    </script>
</html>
